<div class="min-h-screen bg-[#f3eee9]">
  <main class="mx-auto max-w-[1100px] px-6 pb-10 pt-6">
    <div class="mb-6 flex items-center gap-4">
      <div class="inline-block rounded-md bg-[#c6b0e6] px-4 py-2 text-sm tracking-[0.35em]">
        Мои книги
      </div>

      <div class="ml-auto flex items-center gap-2">
        <button
          type="button"
          class="rounded-full bg-[#fdb892] px-3 py-1 hover:opacity-90"
          (click)="openCreateCollection()"
          aria-label="Добавить коллекцию"
          title="Добавить коллекцию"
        >
          +
        </button>

        <div class="relative" data-collections-filter>
          <button
            type="button"
            class="h-10 min-w-[220px] rounded-xl bg-white px-3 text-sm shadow-sm flex items-center justify-between gap-3 hover:bg-black/5"
            (click)="toggleCollectionsMenu()"
          >
            <span class="truncate">
              {{ selectedCollection() ? selectedCollection() : 'Коллекции' }}
            </span>
            <span class="opacity-70">▾</span>
          </button>

          @if (collectionsMenuOpen()) {
            <div
              class="absolute right-0 mt-2 w-[260px] rounded-xl bg-white shadow-lg overflow-hidden border border-black/10 z-30"
            >
              <button
                type="button"
                class="w-full px-4 py-3 text-left text-sm hover:bg-black/5"
                (click)="selectCollection(null)"
              >
                Все книги
              </button>

              <div
  [class.max-h-[176px]]="collectionsScroll()"
  [class.overflow-y-auto]="collectionsScroll()"
>
  @for (c of collections(); track c) {
    <button
      type="button"
      class="w-full px-4 py-3 text-left text-sm hover:bg-black/5"
      (click)="selectCollection(c)"
    >
      {{ c }}
    </button>
  }
</div>

            </div>
          }
        </div>
      </div>
    </div>

    @if (loading()) {
      <div class="py-10 text-center text-sm opacity-70">Загрузка...</div>
    } @else {
      @if (filteredBooks().length === 0) {
        <div class="py-10 text-center text-sm opacity-70">
          Пока пусто. Добавь книгу через “+” на главной.
        </div>
      } @else {
          <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4">
 @for (b of filteredBooks(); track b.bookId) {
  <div
    class="rounded-2xl bg-white p-3 shadow-sm cursor-pointer hover:shadow-md transition"
    role="link"
    tabindex="0"
    (click)="openBook(b)"
    (keydown.enter)="openBook(b)"
  >

                <div class="rounded-xl border border-black/10 bg-white p-2">
                  <img
                    [src]="b.coverUrl || 'icons/no-cover.svg'"
                    [alt]="b.title"
                    class="aspect-[2/3] w-full rounded-lg object-cover"
                    loading="lazy"
                  />
                </div>

                <div class="mt-2 text-[12px] font-semibold leading-tight line-clamp-2">
                  {{ b.title }}
                </div>

                <div class="mt-0.5 text-[11px] opacity-70 line-clamp-1">
                  {{ b.author || '—' }}
                </div>

                <div class="mt-2 flex items-center justify-between">
                  <div class="text-[11px]">
                    <span class="opacity-60">Статус:</span>
                    <span class="ml-1 font-semibold">{{ statusLabel(b.status) }}</span>
                  </div>

                  <div class="relative" data-status-menu>
                    <button
                      type="button"
                      class="h-8 w-8 rounded-xl hover:bg-black/5 flex items-center justify-center"
                      (click)="openStatusMenu(b); $event.stopPropagation()"
                      aria-label="Меню книги"
                      title="Меню"
                    >
                      ⋯
                    </button>

                    @if (statusMenuBook()?.bookId === b.bookId) {
                      <div
  class="absolute right-0 mt-2 w-[210px] rounded-xl bg-white shadow-lg border border-black/10 z-30"
  (click)="$event.stopPropagation()"
>

                        <div class="px-4 py-2 text-[11px] font-semibold opacity-60">Статус</div>
                        <button
  class="w-full px-4 py-2 text-left text-sm hover:bg-black/5"
  (click)="changeStatus(b,'planned'); $event.stopPropagation()"
>Хочу</button>
<button
  class="w-full px-4 py-2 text-left text-sm hover:bg-black/5"
  (click)="changeStatus(b,'reading'); $event.stopPropagation()"
>Читаю</button>
<button
  class="w-full px-4 py-2 text-left text-sm hover:bg-black/5"
  (click)="changeStatus(b,'finished'); $event.stopPropagation()">Прочитано</button>
  <button
  class="w-full px-4 py-2 text-left text-sm hover:bg-black/5"
  (click)="changeStatus(b,'dropped'); $event.stopPropagation()">Брошено</button>

                        <div class="h-px bg-black/10"></div>

                        <button
                          class="w-full px-4 py-3 text-left text-sm hover:bg-black/5 flex items-center gap-2"
                          (click)="openAddToCollection(b)"
                        >
                          <span class="text-base">+</span>
                          <span>В коллекцию</span>
                        </button>
                      </div>
                    }
                  </div>
                </div> 

                <div class="mt-2 text-[11px]">
                  <span class="opacity-60">Коллекции:</span>
                  <span class="ml-1">
                    {{ b.collections?.length ? b.collections.join(', ') : '—' }}
                  </span>
                </div>
              </div>
            }
          </div>
      }
    }
  </main>

  @if (createModalOpen()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4">
      <div class="w-full max-w-[520px] rounded-2xl bg-white shadow-xl overflow-hidden">
        <div class="flex items-center justify-between border-b border-black/10 p-4">
          <div class="text-sm font-semibold">Новая коллекция</div>
          <button type="button" class="h-9 w-9 rounded-xl hover:bg-black/5" (click)="closeCreateCollection()">✕</button>
        </div>

        <div class="p-4">
          <label class="text-xs opacity-70">Название</label>
          <input
            class="mt-1 w-full rounded-xl border border-black/10 px-3 py-2 text-sm outline-none"
            [value]="newCollectionName()"
            (input)="newCollectionName.set(($any($event.target)).value)"
            placeholder="Например: Любимые"
          />

          <div class="mt-4 text-xs opacity-70">Выбери книги для коллекции</div>

          <div class="mt-2 max-h-[260px] overflow-y-auto rounded-xl border border-black/10">
            @for (b of books(); track b.bookId) {
              <label class="flex items-center gap-3 px-3 py-2 hover:bg-black/5 cursor-pointer">
                <input
                  type="checkbox"
                  [checked]="selectedBookIds().has(b.bookId)"
                  (change)="toggleBookSelection(b.bookId)"
                />
                <img
                  class="h-10 w-8 rounded object-cover border border-black/10"
                  [src]="b.coverUrl || 'icons/no-cover.svg'"
                  [alt]="b.title"
                />
                <div class="min-w-0">
                  <div class="text-sm font-semibold leading-tight truncate">{{ b.title }}</div>
                  <div class="text-xs opacity-70 truncate">{{ b.author || '—' }}</div>
                </div>
              </label>
            }
          </div>

          @if (createError()) {
            <div class="mt-3 text-xs text-red-600">{{ createError() }}</div>
          }

          <div class="mt-4 flex items-center justify-end gap-2">
            <button type="button" class="h-10 rounded-xl px-4 text-sm hover:bg-black/5" (click)="closeCreateCollection()">
              Отмена
            </button>
            <button
              type="button"
              class="h-10 rounded-xl bg-[#fdb892] px-4 text-sm font-semibold hover:opacity-95 disabled:opacity-60"
              [disabled]="creatingCollection()"
              (click)="createCollection()"
            >
              Создать
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (addToCollectionOpen()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4" (click)="closeAddToCollection()">
      <div class="w-full max-w-[420px] rounded-2xl bg-white shadow-xl overflow-hidden" (click)="$event.stopPropagation()">
        <div class="flex items-center justify-between border-b border-black/10 p-4">
          <div class="text-sm font-semibold">Добавить в коллекцию</div>
          <button type="button" class="h-9 w-9 rounded-xl hover:bg-black/5" (click)="closeAddToCollection()">✕</button>
        </div>

        <div class="p-4">
          <div class="text-sm font-semibold truncate">{{ addToCollectionBook()?.title }}</div>
          <div class="mt-1 text-xs opacity-70 truncate">{{ addToCollectionBook()?.author || '—' }}</div>

          <div class="mt-4 text-xs opacity-70">Выбери коллекцию</div>

          <div class="mt-2 max-h-[220px] overflow-y-auto rounded-xl border border-black/10">
            @for (c of collectionsList(); track c.id) {
              <button
                type="button"
                class="w-full px-4 py-3 text-left text-sm hover:bg-black/5 flex items-center justify-between"
                (click)="addBookToCollection(c.id)"
              >
                <span class="truncate">{{ c.name }}</span>
                <span class="text-xs opacity-60">{{ c.count }}</span>
              </button>
            }

            @if (collectionsList().length === 0) {
              <div class="px-4 py-3 text-sm opacity-70">Пока нет коллекций</div>
            }
          </div>

          @if (addToCollectionError()) {
            <div class="mt-3 text-xs text-red-600">{{ addToCollectionError() }}</div>
          }
        </div>
      </div>
    </div>
  }
</div>
